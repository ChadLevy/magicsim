<html>
    <head>
        <title>magicsim</title>
        <script src="jquery-3.1.1.min.js"></script>
        <link type="text/css" rel="stylesheet" href="index.css"></link>
        <script>
        var active = false;
        var showHome = function() {
            $("#loading").hide();
            $("#results").hide();
            $("#main").show();
        }
        var showLoading = function() {
            $("#loading").show();
            $("#results").hide();
            $("#main").hide();
        }
        var showResults = function() {
            $("#loading").hide();
            $("#results").show();
            $("#main").hide();
        }
        var doPoll = function() {
            $.ajax({type: "GET",
                     url: "http://localhost:4000/sim/results", 
                     success: function(data){
                        if(data == false) {
                            setTimeout(doPoll,10000);
                        } else if(JSON.parse(data).done != null) {
                            data = JSON.parse(data);
                            $("#done").text(data.done);
                            $("#total").text(data.total);
                            $("#state").text(data.state);
                            if(data.total > 0) {
                                $("#counter").show();
                            }
                            setTimeout(doPoll,10000);
                        } else if(JSON.parse(data).error != null) {
                            alert(JSON.parse(data).error);
                            $('#submit').attr('disabled', false);
                            showHome();
                            active = false;
                        } else {
                            data = JSON.parse(data);
                            $('#submit').attr('disabled', false);
                            $("#counter").hide();
                            showResults();
                            $("#pawn").text(data.pawn);
                            if(data.pawn == '') {
                                $("#pawn").hide();
                            } else {
                                $("#pawn").show();
                            }
                            $("#damage").text(data.damage);
                            $("#sims").text(data.sims);
                            active = false;
                        }
                    }, 
                    error: function(req, stat, err) {
                        alert(err);
                        $('#submit').attr('disabled', false);
                        showHome();
                        active = false;
                    }});
        }
        $(document).ready(function(){
            var realm,region,character;
            $("#counter").hide();
            showHome();
            $("#submit").click(function(){
                realm=$("#realm").val();
                region=$("#region").val();
                character=$("#character").val();
                threads=$("#workers").val();
                noweights=$("#workers").val();
                ptr=$("#ptr").val();
                if(!active) {
                    active = true;
                    $.ajax({type: "POST",
                     url: "http://localhost:4000/sim/request", 
                     data: {character: character, region: region, realm: realm, threads: threads, noweights: noweights, ptr: ptr}, 
                     success: function(data){
                        if(data == true) {
                            doPoll();
                            showLoading();
                            $('#submit').attr('disabled', true);
                        }
                    }, 
                    error: function(req, stat, err) {
                        alert(err);
                        active = false;
                    }});
                }
            });
        });
        </script>
    </head>
    <body>
        <div id="main">
            <h2 class="header">magicsim</h2>
            <p>Automated H2Priest-style Armory Sims.</p>
            <div class="container">
                <div class="item">
                    <label for="region">Region:</label>
                    <select id="region" name="region">
                        <option value="us">US (North America)</option>
                        <option value="eu">EU (Europe)</option>
                        <option value="cn">CN (China)</option>
                        <option value="kr">KR (South Korea)</option>
                        <option value="tw">TW (Taiwan)</option>
                    </select>
                </div>
                <div class="item"><label for="realm">Realm:</label><input type="text" name="realm" id="realm" /></div>
                <div class="item"><label for="character">Character:</label><input type="text" name="character" id="character" /></div>
                <div class="item"><label for="workers">Threads:</label><input type="range" name="workers" id="workers" min="1" max="8" value="4" onchange="$('#threads').text(this.value)" /> <span id="threads">4</span></div>
                <div class="item">
                    <label for="noweights">No Weights:</label><input type="checkbox" name="noweights" id="noweights" />
                    <label for="ptr">PTR Mode:</label><input type="checkbox" name="ptr" id="ptr" />
                </div>
            </div>
            <div class="item submit"><input type="submit" id="submit" value="Simulate" ></div>
        </div>
        <div id="loading">
            <div id="loadingHeader"><span id="state">Starting</span>.</div>
            <div class="element">
                <div class="loading2">
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                    <div></div>
                </div>
            </div>
            <div id="counter"><span id="done"></span>/<span id="total"></span> sims completed</div>
        </div>
        <div id="results">
            <h3>Simulation Complete!</h3>
            <div class="item">Aggregate Damage Results:</div>
            <div id="damage"></div>
            <div class="item">Pawn String:</div>
            <div id="pawn"></div>
            <div class="item">Simulations Ran:</div>
            <div id="sims"></div>
            <div class="item submit"><input type="button" id="button" value="Run New Sim" onclick="showHome()" ></input></div>
        </div>
    </body>
</html>