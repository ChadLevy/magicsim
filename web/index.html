<html>
    <head>
        <title>magicsim</title>
        <script src="jquery-3.1.1.min.js"></script>
        <link type="text/css" rel="stylesheet" href="index.css"></link>
        <script>
        var active = false;
        var advancedMode = false;
        var race = [
            {name:"Default", value:"DEFAULT"},
            {name:"Blood Elf", value:"blood_elf"},
            {name:"Orc", value:"orc"},
            {name:"Undead", value:"undead"},
            {name:"Goblin", value:"goblin"},
            {name:"Troll", value:"troll"},
            {name:"Tauren", value:"tauren"},
            {name:"Night Elf", value:"night_elf"},
            {name:"Human", value:"human"},
            {name:"Draenei", value:"draenei"},
            {name:"Gnome", value:"gnome"},
            {name:"Dwarf", value:"dwarf"},
            {name:"Worgen", value:"worgen"},
            {name:"Pandaren", value:"pandaren"}
        ];
        var food = [
            {name:"Default", value:"DEFAULT"},
            {name:"Azshari Salad", value:"azshari_salad"},
            {name:"Nightborne Delicacy Platter", value:"nightborne_delicacy_platter"},
            {name:"Seed-Battered Fish Plate", value:"seedbattered_fish_plate"},
            {name:"The Hungry Magister", value:"the_hungry_magister"},
            {name:"Fishbrul Special", value:"fishbrul_special"},
            {name:"None", value:"DELETE"}
        ];
        var flask = [
            {name:"Default", value:"DEFAULT"},
            {name:"Flask of the Whispered Pact", value:"flask_of_the_whispered_pact"},
            {name:"Flask of the Seventh Demon", value:"flask_of_the_seventh_demon"},
            {name:"Flask of Ten Thousand Scars", value:"flask_of_ten_thousand_scars"},
            {name:"Flask of the Countless Armies", value:"flask_of_the_countless_armies"},
            {name:"None", value:"DELETE"}
        ];
        var potion = [
            {name:"Default", value:"DEFAULT"},
            {name:"Unbending Potion", value:"unbending_potion"},
            {name:"Potion of Prolonged Power", value:"prolonged_power"},
            {name:"Potion of Deadly Grace", value:"deadly_grace"},
            {name:"Potion of the Old War", value:"old_war"},
            {name:"None", value:"DELETE"}
        ]; 
        var rune = [
            {name:"Default", value:"DEFAULT"},
            {name:"Defiled Augment Rune", value:"defiled"},
            {name:"None", value:"DELETE"}
        ]; 
        var setbonus = [
            {name:"Default", value:"DEFAULT"},
            {name:"Tier 19 2/6", value:"19:2pc=1,4pc=0"},
            {name:"Tier 19 4/6", value:"19:2pc=1,4pc=1"},
            {name:"Tier 20 2/6 (PTR)", value:"20:2pc=1,4pc=0"},
            {name:"Tier 20 4/6 (PTR)", value:"20:2pc=1,4pc=1"},
            {name:"Tier 19 2/6, Tier 20 4/6 (PTR)", value:"19:2pc=1,4pc=0;20:2pc=1,4pc=1"},
            {name:"Tier 19 4/6, Tier 20 2/6 (PTR)", value:"19:2pc=1,4pc=1;20:2pc=1,4pc=0"},
            {name:"No tier", value:"19:2pc=1,4pc=0"}
        ]
        var showHome = function() {
            $("#loading").hide();
            $("#results").hide();
            $("#main").show();
        }
        var showLoading = function() {
            $("#loading").show();
            $("#results").hide();
            $("#main").hide();
        }
        var showResults = function() {
            $("#loading").hide();
            $("#results").show();
            $("#main").hide();
        }
        var loadOptions = function(select, option) {
            option.forEach((item) => {
                select.append($("<option value=\"" + item.value + "\">" + item.name + "</option>"));
            });
        }
        var updateRealms = function(region) {
            $.get('https://'+ region +'.api.battle.net/wow/realm/status?locale=en_US&apikey=y592n6pwqj7rypxbswa2x4ek5umg4462',
                function(data, status) {
                    $("#realm").empty();
                    data.realms.map(function(realm) {
                        return realm.name;
                    }).forEach(function(name) {
                        var opt = $("<option value=\"" + name.replace(/ /g, '-') + "\">" + name + "</option>")
                        $("#realm").append(opt);
                    })
                }, 'json'
            )
        }
        var versionCheck = function(version) {
            $.get('https://api.github.com/repos/phroph/magicsim/releases/latest', 
                function(data) {
                    var vers = JSON.parse(data).tag_name;
                    if(version != vers) {
                        alert("Newer app available on GitHub. Check for a new release (https://github.com/phroph/magicsim/releases/latest).");
                    }
                }, 'text')
        }
        var doPoll = function() {
            $.ajax({type: "GET",
                     url: "http://localhost:4000/sim/results", 
                     success: function(data){
                        if(data == false) {
                            setTimeout(doPoll,10000);
                        } else if(JSON.parse(data).done != null) {
                            data = JSON.parse(data);
                            $("#done").text(data.done);
                            $("#total").text(data.total);
                            $("#state").text(data.state);
                            if(data.total > 0) {
                                $("#counter").show();
                            }
                            setTimeout(doPoll,10000);
                        } else if(JSON.parse(data).error != null) {
                            alert(JSON.parse(data).error);
                            $('#submit').attr('disabled', false);
                            showHome();
                            active = false;
                        } else {
                            data = JSON.parse(data);
                            $('#submit').attr('disabled', false);
                            $("#counter").hide();
                            showResults();
                            $("#pawn").text(data.pawn);
                            if(data.pawn == '') {
                                $("#pawn").hide();
                                $("#pawnlabel").hide();
                            } else {
                                $("#pawn").show();
                                $("#pawnlabel").show();
                            }
                            $("#damage").text(data.damage);
                            $("#sims").text(data.sims);
                            active = false;
                        }
                    }, 
                    error: function(req, stat, err) {
                        alert(err);
                        $('#submit').attr('disabled', false);
                        showHome();
                        active = false;
                    }});
        }
        $(document).ready(function(){
            var realm,region,character;
            updateRealms("us");
            loadOptions($('#food'),food);
            loadOptions($('#potion'),potion);
            loadOptions($('#rune'),rune);
            loadOptions($('#flask'),flask);
            loadOptions($('#race'),race);
            loadOptions($('#setbonus'),setbonus)
            $('#simpleSubmit').hide();
            $("#counter").hide();
            $('#advanced').hide();
            showHome();
            versionCheck(process.mainModule.exports.version);
            $.ajax({type: "GET",
                     url: "http://localhost:4000/sim/models",
                     success: function(data) {
                         data = JSON.parse(data);
                         data.forEach(function(model) {
                             var opt = $("<option value=\'" + model.name + "\'>" + model.dispName + "</option>")
                             $("#model").append(opt);
                         })
                     } 

            });
            $("#advancedSubmit").click(function() {
                $('#advanced').show();
                $('#advancedSubmit').hide();
                $('#simpleSubmit').show();
                advancedMode = true;
                require('nw.gui').Window.get().width = 655;
            })
            $("#simpleSubmit").click(function() {
                $('#advanced').hide();
                $('#advancedSubmit').show();
                $('#simpleSubmit').hide();
                advancedMode = false;
                require('nw.gui').Window.get().width = 300;
            })
            $("#submit").click(function(){
                realm=$("#realm").val();
                region=$("#region").val();
                character=$("#character").val();
                threads=$("#workers").val();
                model=$("#model").val();
                noweights=$("#noweights")[0].checked;
                ptr=$("#ptr")[0].checked;
                if(!active) {
                    active = true;
                    var data;
                    if(advancedMode) {
                        var advancedOpts = JSON.stringify([
                         {name:'food', replacement: $('#food').val()},
                         {name:'rune', replacement: $('#rune').val()},
                         {name:'potion', replacement: $('#potion').val()},
                         {name:'flask', replacement: $('#flask').val()},
                         {name:'race', replacement: $('#race').val()},
                         {name:'setbonus',replacement: $('#setbonus').val()}
                        ])
                        data = {character: character, region: region, realm: realm, threads: threads, noweights: noweights, ptr: ptr, model: model, advancedMode: advancedMode, advancedOptions: advancedOpts};
                    } else {
                        data = {character: character, region: region, realm: realm, threads: threads, noweights: noweights, ptr: ptr, model: model, advancedMode: advancedMode};
                    }
                    $.ajax({type: "POST",
                     url: "http://localhost:4000/sim/request", 
                     data: {character: character, region: region, realm: realm, threads: threads, noweights: noweights, ptr: ptr, model: model, advancedMode: advancedMode, advancedOptions: advancedOpts}, 
                     success: function(data){
                        if(data == true) {
                            doPoll();
                            showLoading();
                            $('#submit').attr('disabled', true);
                        }
                    }, 
                    error: function(req, stat, err) {
                        alert(err);
                        active = false;
                    }});
                    require('nw.gui').Window.get().width = 300;
                }
            });
            process.mainModule.exports.window = require('nw.gui').Window.get();
        });
        </script>
    </head>
    <body>
        <div id="simple">
            <div id="main">
                <h2 class="header">magicsim</h2>
                <div class="subheader">Automated H2Priest-style Armory Sims.</div>
                <div class="container">
                    <div class="item">
                        <label for="region">Region:</label>
                        <select id="region" name="region" onchange="updateRealms(this.value)" >
                            <option value="us">US (North America)</option>
                            <option value="eu">EU (Europe)</option>
                            <option value="kr">KR (South Korea)</option>
                            <option value="tw">TW (Taiwan)</option>
                        </select>
                    </div>
                    <div class="item">
                        <label for="realm">Realm:</label>
                        <select id="realm" name="realm"></select>
                    </div>
                    <div class="item"><label for="character">Character:</label><input type="text" name="character" id="character" /></div>
                    <div class="item">
                        <label for="model">Model:</label>
                        <select id="model" name="model"></select>
                    </div>
                    <div class="item"><label for="workers">Threads:</label><input type="range" name="workers" id="workers" min="1" max="8" value="4" onchange="$('#threads').text(this.value)" /> <span id="threads">4</span></div>
                    <div class="item">
                        <label for="noweights">No Weights:</label><input type="checkbox" name="noweights" id="noweights" />
                        <label for="ptr">PTR Mode:</label><input type="checkbox" name="ptr" id="ptr" />
                    </div>
                </div>
                <div id="advanced" class="container">
                    <div class="item">
                        <label for="potion">Potion:</label>
                        <select class="advancedOption" id="potion" name="potion"></select>
                    </div>
                    <div class="item">
                        <label for="rune">Rune:</label>
                        <select class="advancedOption" id="rune" name="rune"></select>
                    </div>
                    <div class="item">
                        <label for="flask">Flask:</label>
                        <select class="advancedOption" id="flask" name="flask"></select>
                    </div>
                    <div class="item">
                        <label for="food">Food:</label>
                        <select class="advancedOption" id="food" name="food"></select>
                    </div>
                    <div class="item">
                        <label for="race">Race:</label>
                        <select class="advancedOption" id="race" name="race"></select>
                    </div>
                    <div class="item">
                        <label for="setbonus">Set Bonuses:</label>
                        <select class="advancedOption" id="setbonus" name="setbonus"></select>
                    </div>
                </div>
                <span class="item"><input type="submit" id="advancedSubmit" value="Advanced" ></span>
                <span class="item"><input type="submit" id="simpleSubmit" value="Simple" ></span>
                <span class="item"><input type="submit" id="submit" value="Simulate" ></span>
            </div>
            <div id="loading">
                <div id="loadingHeader"><span id="state">Starting</span>.</div>
                <div class="element">
                    <div class="loading2">
                        <div></div>
                        <div></div>
                        <div></div>
                        <div></div>
                        <div></div>
                        <div></div>
                        <div></div>
                        <div></div>
                    </div>
                </div>
                <div id="counter"><span id="done"></span>/<span id="total"></span> sims completed</div>
            </div>
            <div id="results">
                <h3>Simulation Complete!</h3>
                <div class="item">Aggregate Damage Results:</div>
                <div id="damage"></div>
                <div class="item" id="pawnlabel">Pawn String:</div>
                <div id="pawn"></div>
                <div class="item">Simulations Ran:</div>
                <div id="sims"></div>
                <div class="item submit"><input type="button" id="button" value="Run New Sim" onclick="showHome()" ></input></div>
            </div>
        </div>
    </body>
</html>